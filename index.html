<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مصر 2030: التحفة النهائية - الإصدار الكامل</title>

  <!-- خطوط -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Reem+Kufi+Fun:wght@700&family=Amiri:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Day Theme */
      --bg: #f4f7fc;
      --text: #1a1f2c;
      --sub-text: #5a6476;
      --panel-bg: rgba(255, 255, 255, 0.6);
      --panel-border: rgba(0, 0, 0, 0.1);
      --shadow: 0 10px 30px rgba(0,0,0,0.1);
      --gold: #b58a00;
      --gold-gradient: linear-gradient(45deg, #d4af37, #fdf4d0, #b58a00);
      --success: #28a745;
      --error: #dc3545;
      --like-color: #e2264d;
    }
    [data-theme='night']{
      /* Night Theme */
      --bg: #0a0c14;
      --text: #f4f6f9;
      --sub-text: #a8b2bd;
      --panel-bg: rgba(14, 19, 32, 0.6);
      --panel-border: rgba(255, 255, 255, 0.1);
      --shadow: 0 10px 40px rgba(0,0,0,0.4);
      --gold: #ffd54a;
      --gold-gradient: linear-gradient(45deg, #ffd54a, #fff, #ffd54a);
      --success: #3bc45a;
      --error: #e54d5b;
    }
    
    *{box-sizing:border-box}
    html,body{height:100%;-webkit-font-smoothing:antialiased}
    body{margin:0;font-family:'Amiri',serif;color:var(--text);background:var(--bg);overflow-x:hidden;transition:background .4s ease,color .4s ease}
    
    #three-bg { position: fixed; top: 0; left: 0; outline: none; z-index: -1; }
    .main-wrapper {height: 100vh;width: 100vw;overflow-y: auto;overflow-x: hidden;perspective: 10px;}
    header{position: sticky;top: 10px;z-index: 100;padding: 0 20px;display: flex;justify-content: center;}
    .nav{width: 100%;max-width: 1200px;padding: 10px 20px;display: flex;align-items: center;justify-content: space-between;background: var(--panel-bg);border-radius: 14px;border: 1px solid var(--panel-border);backdrop-filter: blur(12px);box-shadow: var(--shadow);}
    .brand{display:flex;align-items:center;gap:15px}
    .gif-flag { width: 50px; height: 33px; border-radius: 4px; border: 1px solid var(--panel-border); object-fit: cover; }
    .header-title{margin:0;font-family:'Reem Kufi Fun';font-size:20px;background: var(--gold-gradient);-webkit-background-clip:text; -webkit-text-fill-color:transparent;}
    .icon-btn{background:transparent;border:0;padding:8px;cursor:pointer;color:var(--sub-text);display:grid;place-items:center}
    
    .ticker-wrapper { position: sticky; top: 85px; z-index: 90; width: 100%; padding: 0 20px; margin-top: -10px; margin-bottom: 10px; }
    .news-ticker-container { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; background-color: var(--panel-bg); backdrop-filter: blur(10px); border-radius: 12px; padding: 8px 15px; overflow: hidden; border: 1px solid var(--panel-border); box-shadow: var(--shadow); }
    .news-ticker-title { font-family: 'Reem Kufi Fun'; font-size: 1rem; color: var(--gold); white-space: nowrap; padding-left: 15px; }
    .news-ticker-content { flex-grow: 1; position: relative; height: 24px; overflow: hidden; }
    .news-item { position: absolute; top: 0; left: 0; width: 100%; text-align: center; white-space: nowrap; font-size: 0.95rem; color: var(--sub-text); animation: slide-item 15s linear forwards; }
    @keyframes slide-item { 0%   { transform: translateX(100%); opacity: 0; } 10%  { transform: translateX(0); opacity: 1; } 90%  { transform: translateX(0); opacity: 1; } 100% { transform: translateX(-100%); opacity: 0; } }

    .hero{text-align:center;padding:60px 20px 80px}
    .main-title{ font-family:'Reem Kufi Fun'; font-weight:700; font-size:clamp(40px,8vw,90px); margin:0; background: var(--gold-gradient); -webkit-background-clip:text;-webkit-text-fill-color:transparent; filter: drop-shadow(0 5px 20px rgba(181, 138, 0, 0.4)); animation: shimmer 5s infinite ease-in-out; background-size: 200% 200%; }
    @keyframes shimmer { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    
    .slider-container{padding: 40px 20px; position:relative; max-width:1200px; margin: 0 auto;}
    .slide-wrap{position:relative;min-height:450px;}
    .slide{position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:center;opacity:0;visibility:hidden;transition:opacity .8s ease;}
    .slide.active{opacity:1;visibility:visible}
    .slide-content {transform: translateX(-100px); transition: transform 1.2s cubic-bezier(.22,1,.36,1);}
    .slide.active .slide-content {transform: translateX(0);}
    .slide-image-flipper { perspective: 1500px; transform: translateX(100px); transition: transform 1.2s cubic-bezier(.22,1,.36,1); height: 450px; }
    .slide.active .slide-image-flipper { transform: translateX(0); }
    .flipper-card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .flipper-card.is-flipped { transform: rotateY(180deg); }
    .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); }
    .card-face img { width: 100%; height: 100%; object-fit: cover; }
    .card-face.card-back { transform: rotateY(180deg); }
    .slide-content{padding: 20px; background: var(--panel-bg); backdrop-filter: blur(12px); border-radius: 16px; border: 1px solid var(--panel-border);}
    .slide-content h3{margin:0 0 15px;font-family:'Reem Kufi Fun';font-size:clamp(28px,4vw,40px);color:var(--gold)}
    .slide-content p{margin:0 0 25px;font-size:1.2rem;line-height:1.9}
    .slider-nav {display:flex;justify-content:center;gap:15px;margin-top:40px;}
    .nav-arrow {width:50px;height:50px;border-radius:50%;border:1px solid var(--panel-border);background:var(--panel-bg);cursor:pointer;display:grid;place-items:center;color:var(--text);transition: all .3s ease;}
    
    .video-gallery-section { padding: 50px 20px; max-width: 1300px; margin: 40px auto; }
    .gallery-title { text-align: center; font-family: 'Reem Kufi Fun'; font-size: clamp(30px, 5vw, 45px); color: var(--gold); margin-bottom: 40px; }
    #video-gallery { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .video-card-thumbnail { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 12px; backdrop-filter: blur(10px); box-shadow: var(--shadow); overflow: hidden; cursor: pointer; position: relative; }
    .video-card-thumbnail::before { content: '▶'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; color: rgba(255,255,255,0.8); text-shadow: 0 0 10px black; transition: transform .3s ease; }
    .video-card-thumbnail:hover::before { transform: translate(-50%, -50%) scale(1.2); }
    .video-card-thumbnail img { width: 100%; height: 120px; object-fit: cover; display: block; background-color: #000; }
    .video-card-title { padding: 10px; font-weight: 700; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }

    @media (min-width: 768px) { #video-gallery { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; } .video-card-thumbnail img { height: 160px; } .video-card-title { font-size: 1.1rem; padding: 15px; } }
    @media (max-width:900px){.slide{grid-template-columns:1fr;text-align:center}.slide-image-flipper{height:300px}}

    .fab { position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px; background: var(--gold-gradient); border-radius: 50%; display: grid; place-items: center; color: #fff; font-size: 36px; font-weight: 300; line-height: 1; cursor: pointer; box-shadow: 0 5px 20px rgba(181, 138, 0, 0.5); z-index: 250; transition: transform .3s ease; }
    .fab:hover { transform: scale(1.1) rotate(90deg); }

    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:260;display:grid;place-items:center;opacity:0;visibility:hidden;transition:all .4s ease}
    .modal-overlay.visible{opacity:1;visibility:visible}
    .modal-card{width:min(500px,95%);max-height:90vh;overflow-y:auto;border-radius:16px;padding:30px 40px;background:var(--bg);border:1px solid var(--panel-border);position:relative;transform:scale(.9);transition:transform .4s ease}
    .modal-overlay.visible .modal-card {transform:scale(1);}
    .modal-close{position:absolute;top:15px;left:15px;cursor:pointer;color:var(--gold);width:40px;height:40px;background:var(--panel-bg);border:1px solid var(--panel-border);border-radius:50%;display:grid;place-items:center}
    #upload-form label { font-size: 1rem; margin-bottom: 8px; display: block; }
    #upload-form input, #upload-form button { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--panel-border); background-color: var(--panel-bg); font-family: 'Amiri', serif; font-size: 1rem; margin-bottom: 20px; color: var(--text); }
    #upload-form button { background: var(--gold); color: var(--bg); border: none; cursor: pointer; }
    #upload-form button:disabled { background: var(--sub-text); cursor: not-allowed; }
    #upload-status { text-align: center; display: none; margin-top: 10px; padding: 10px; border-radius: 8px; }
    #upload-status.success { color: #fff; background-color: var(--success); } #upload-status.error { color: #fff; background-color: var(--error); }
    
    #video-player-modal { position: fixed; inset: 0; z-index: 300; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); display: none; flex-direction: column; justify-content: center; align-items: center; }
    #video-player-modal.visible { display: flex; }
    .player-container { width: 90%; max-width: 1100px; max-height: 95vh; display: flex; flex-direction: column; background: var(--bg); border-radius: 12px; overflow: hidden; border: 1px solid var(--panel-border);}
    .video-area { flex-grow: 1; position: relative; background-color: #000; }
    #player-video { width: 100%; height: 100%; display: block; }
    .custom-controls { padding: 10px; background: rgba(0,0,0,0.3); display: flex; align-items: center; gap: 15px; }
    .control-btn { background: none; border: none; color: #fff; cursor: pointer; padding: 5px; font-size: 1.2rem;}
    .progress-bar { flex-grow: 1; background: rgba(255,255,255,0.3); cursor: pointer; height: 5px; border-radius: 3px; }
    #progress-fill { width: 0%; height: 100%; background: var(--gold); border-radius: 3px; }
    .volume-controls { display: flex; align-items: center; }
    #volume-slider { width: 80px; accent-color: var(--gold); }
    .interaction-area { padding: 15px; background: var(--panel-bg); border-top: 1px solid var(--panel-border); max-height: 35vh; overflow-y: auto; }
    .video-actions { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
    .like-btn { background: none; border: 1px solid var(--sub-text); color: var(--sub-text); padding: 8px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 1rem; }
    .like-btn.liked { background-color: var(--like-color); border-color: var(--like-color); color: #fff; }
    .download-btn { display: inline-flex; align-items: center; gap: 8px; text-decoration: none; color: var(--sub-text); font-size: 0.9rem; padding: 5px 10px; border-radius: 8px; }
    .comments-section h4 { margin: 0 0 15px; border-bottom: 1px solid var(--panel-border); padding-bottom: 10px; }
    #comments-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; max-height: 150px; overflow-y: auto;}
    .comment { background: var(--bg); padding: 10px; border-radius: 8px; }
    .comment-author { font-weight: bold; color: var(--gold); }
    .comment-text { margin: 5px 0 0; }
    #comment-form { display: flex; gap: 10px; flex-wrap: wrap;}
    #comment-form input { flex-basis: 100%; background: var(--bg); border: 1px solid var(--panel-border); padding: 10px; border-radius: 8px; color: var(--text); }
    #comment-form input#comment-name { flex-basis: 30%; }
    #comment-form input#comment-text { flex-basis: 65%; }
    #comment-form button { background: var(--gold); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; color: var(--bg); width: 100%; margin-top: 5px; }
    .close-player-btn { position: absolute; top: 15px; right: 20px; font-size: 30px; color: #fff; background: none; border: none; cursor: pointer; text-shadow: 0 0 5px black; }

    .site-footer {padding: 40px 20px;margin-top: 80px;text-align: center;background: var(--panel-bg);backdrop-filter: blur(10px);border-top: 1px solid var(--panel-border);}
    .social-links a { color: var(--sub-text); margin: 0 10px; transition: color .3s ease;}
    .copyright {margin-top: 15px; font-size: 0.9rem; color: var(--sub-text);}
  </style>
</head>
<body data-theme="day">

  <canvas id="three-bg"></canvas>

  <div class="main-wrapper">
    <header>
      <div class="nav">
        <div class="brand">
          <img src="https://i.postimg.cc/7hjMcXpc/1iC-I4.gif" alt="علم مصر المتحرك" class="gif-flag">
          <h2 class="header-title">رؤية مصر 2030</h2>
        </div>
        <button class="icon-btn" id="themeBtn" title="تبديل الوضع">
            <svg id="theme-icon-sun" viewBox="0 0 24 24"><path fill="currentColor" d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41l-1.06-1.06zM5.64 18.36l1.06-1.06c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0zm12.73-12.73l1.06-1.06c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.06 1.06c-.39-.39-.39 1.02 0 1.41s1.02.39 1.41 0z"/></svg>
            <svg id="theme-icon-moon" style="display:none;" viewBox="0 0 24 24"><path fill="currentColor" d="M11.23 3.41c.2-.2.52-.22.75-.05.23.17.34.45.28.72-1.35 5.56 3.48 10.39 9.04 9.04.27-.06.55.05.72.28.17.23.15.55-.05.75-2.58 2.58-6.15 4.15-10.04 4.15-6.63 0-12-5.37-12-12 0-3.89 1.57-7.46 4.15-10.04z"/></svg>
        </button>
      </div>
    </header>
    
    <div class="ticker-wrapper">
        <div class="news-ticker-container">
            <span class="news-ticker-title">مصر الآن:</span>
            <div id="news-ticker-content" class="news-ticker-content"></div>
        </div>
    </div>

    <main>
      <section class="hero"><h2 class="main-title">مصر تُبهر العالم</h2></section>
      
      <section class="slider-container">
        <div class="slide-wrap" id="slide-wrap"></div>
        <div class="slider-nav">
          <button class="nav-arrow" id="prevBtn" aria-label="السابق"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg></button>
          <button class="nav-arrow" id="nextBtn" aria-label="التالي"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg></button>
        </div>
      </section>

      <section class="video-gallery-section">
        <h2 class="gallery-title">مشاركات الفيديو</h2>
        <div id="video-gallery"></div>
      </section>
    </main>
    
    <div class="modal-overlay" id="modal-details">
      <div class="modal-card">
        <button class="modal-close" id="closeModal-details">&times;</button>
        <h3 id="modal-title"></h3><p id="modal-body"></p>
      </div>
    </div>
    
    <footer class="site-footer">
        <div class="social-links">
            <a href="#" aria-label="فيسبوك"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55 0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z"/></svg></a>
            <a href="#" aria-label="تويتر"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M22.46 6c-.77.35-1.6.58-2.46.67.88-.53 1.56-1.37 1.88-2.38-.83.49-1.75.85-2.72 1.04C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.22-1.95-.54v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.52 8.52 0 0 1-5.33 1.84c-.34 0-.68-.02-1.01-.06C3.18 20.79 5.38 21.5 7.7 21.5c7.32 0 11.33-6.06 11.33-11.33 0-.17 0-.34-.01-.51.78-.56 1.45-1.26 1.99-2.03z"/></svg></a>
        </div>
        <p class="copyright" id="copyright"></p>
    </footer>
  </div>

  <div class="fab" id="fab-upload" title="رفع فيديو جديد">+</div>

  <div class="modal-overlay" id="upload-modal">
    <div class="modal-card">
        <button class="modal-close" id="close-upload-modal">&times;</button>
        <h3 style="text-align:center; font-family:'Reem Kufi Fun'; color: var(--gold);">رفع فيديو جديد</h3>
        <form id="upload-form">
            <label for="video-title">عنوان الفيديو:</label>
            <input type="text" id="video-title" required>
            <label for="video-file">ملف الفيديو (ملفات صغيرة جداً فقط):</label>
            <input type="file" id="video-file" accept="video/*" required>
            <p id="upload-status"></p>
            <button type="submit" id="submit-upload-btn">رفع الآن</button>
        </form>
    </div>
  </div>
  
  <div id="video-player-modal">
    <button id="close-player-btn" class="close-player-btn">&times;</button>
    <div class="player-container">
        <div class="video-area"><video id="player-video"></video></div>
        <div class="custom-controls">
            <button class="control-btn" id="play-pause-btn">▶</button>
            <div class="progress-bar" id="progress-bar-container"><div id="progress-fill"></div></div>
            <div class="volume-controls">
                <button class="control-btn">🔊</button>
                <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1">
            </div>
        </div>
        <div class="interaction-area">
            <div class="video-actions">
                <button class="like-btn" id="like-btn">❤️ <span>0</span></button>
                <a href="#" id="player-download-btn" class="download-btn"><span>تحميل</span></a>
            </div>
            <div class="comments-section">
                <h4>التعليقات</h4>
                <div id="comments-list"></div>
                <form id="comment-form">
                    <input type="text" id="comment-name" placeholder="الاسم (اختياري)">
                    <input type="text" id="comment-text" placeholder="أضف تعليقاً..." required>
                    <button type="submit">إرسال</button>
                </form>
            </div>
        </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
    // ===============================================================
    // ضع إعدادات Firebase الخاصة بك هنا
    // ===============================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCcqpstSz3Wg6zQb_-bC0JyjcJjX5c3TQ8",
        authDomain: "saifsa-d4bee.firebaseapp.com",
        databaseURL: "https://saifsa-d4bee-default-rtdb.firebaseio.com",
        projectId: "saifsa-d4bee",
        storageBucket: "saifsa-d4bee.appspot.com",
        messagingSenderId: "56650923251",
        appId: "1:56650923251:web:83ed4afadf44f8eabf0b86"
    };
    // ===============================================================

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const els={body:document.body,slideWrap:document.getElementById('slide-wrap'),detailsModal:document.getElementById('modal-details'),modalTitle:document.getElementById('modal-title'),modalBody:document.getElementById('modal-body'),closeModalBtn:document.getElementById('closeModal-details'),themeBtn:document.getElementById('themeBtn'),prevBtn:document.getElementById('prevBtn'),nextBtn:document.getElementById('nextBtn'),copyright:document.getElementById('copyright'), newsTicker: document.getElementById('news-ticker-content')};
    
    // --- SLIDER, NEWS, 3D BACKGROUND, AND OLD UI LOGIC ---
    const PROJECTS = [ {id:1,title:"العاصمة الإدارية الجديدة",desc:"مدينة مستقبل ذكية.",images:["https://i.postimg.cc/CxN62pxf/FB-IMG-1755179530591.jpg","https://i.postimg.cc/TP3HMNKN/FB-IMG-1755179596151.jpg"],more:"تفاصيل أوسع حول العاصمة الإدارية..."}, {id:2,title:"محطة بنبان للطاقة الشمسية",desc:"أكبر مجمعات الطاقة الشمسية.",images:["https://i.postimg.cc/wx18sMT4/image.jpg","https://i.postimg.cc/yxgP6wKn/1557299811-553-175541-1920-zonnepark41200x675.jpg"],more:"تفاصيل أوسع حول محطة بنبان..."}, {id:3,title:"مبادرة حياة كريمة",desc:"تطوير شامل للريف المصري.",images:["https://i.postimg.cc/8C4wZRwd/image.jpg","https://i.postimg.cc/q74jcbcM/19-2024-638474847516318591-631.jpg"],more:"تفاصيل أوسع حول حياة كريمة..."}, ];
    const NEWS_ITEMS = [ "مشروع الدلتا الجديدة يستهدف استصلاح أكثر من مليون فدان.", "افتتاح المتحف المصري الكبير.", "شبكة القطار الكهربائي السريع تربط أنحاء الجمهورية.", "مصر تطلق القمر الصناعي \"طيبة-1\".", "تطوير منطقة قناة السويس الاقتصادية." ];
    let currentIndex=0, slideshowInterval, flipInterval;
    const SLIDESHOW_DELAY = 8000, FLIP_DELAY = SLIDESHOW_DELAY / 2;
    function buildSlides(){ if(!els.slideWrap) return; els.slideWrap.innerHTML=PROJECTS.map((p,i)=>`<article class="slide ${i===0?'active':''}" data-index="${i}"><div class="slide-image-flipper"><div class="flipper-card" data-flipper-for="${i}"><div class="card-face card-front"><img src="${p.images[0]}" alt="${p.title} 1"/></div><div class="card-face card-back"><img src="${p.images[1]}" alt="${p.title} 2"/></div></div></div><div class="slide-content"><h3>${p.title}</h3><p>${p.desc}</p><button class="icon-btn" style="align-self:start" data-id="${p.id}">المزيد</button></div></article>`).join('') }
    function setActiveSlide(index){ document.querySelectorAll('.flipper-card').forEach(f => f.classList.remove('is-flipped')); document.querySelector('.slide.active')?.classList.remove('active'); document.querySelector(`.slide[data-index="${index}"]`)?.classList.add('active'); }
    function changeSlide(dir){ currentIndex=(currentIndex+dir+PROJECTS.length)%PROJECTS.length; setActiveSlide(currentIndex); resetIntervals(); }
    function resetIntervals(){ if(!els.slideWrap) return; clearInterval(slideshowInterval); clearTimeout(flipInterval); slideshowInterval=setInterval(()=>changeSlide(1), SLIDESHOW_DELAY); flipInterval = setTimeout(() => { const currentFlipper = document.querySelector(`.flipper-card[data-flipper-for="${currentIndex}"]`); if(currentFlipper) currentFlipper.classList.add('is-flipped'); }, FLIP_DELAY); }
    let newsIndex = 0;
    function runNewsTicker() { if (!els.newsTicker || NEWS_ITEMS.length === 0) return; const newsItem = document.createElement('div'); newsItem.className = 'news-item'; newsItem.textContent = NEWS_ITEMS[newsIndex]; els.newsTicker.appendChild(newsItem); newsItem.addEventListener('animationend', () => { newsItem.remove(); }); newsIndex = (newsIndex + 1) % NEWS_ITEMS.length; setTimeout(runNewsTicker, 15000); }
    const scene=new THREE.Scene();const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);const renderer=new THREE.WebGLRenderer({canvas:document.getElementById('three-bg'),alpha:true});renderer.setSize(window.innerWidth,window.innerHeight);camera.position.z=5;const pyramidGeo=new THREE.ConeGeometry(1,2,4);const pyramidMat=new THREE.MeshBasicMaterial({color:0xD4AF37,wireframe:true});for(let i=0;i<50;i++){const p=new THREE.Mesh(pyramidGeo,pyramidMat);p.position.set((Math.random()-.5)*50,(Math.random()-.5)*50,(Math.random()-.5)*50);p.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI);scene.add(p)}
    function animate3D(){requestAnimationFrame(animate3D);renderer.render(scene,camera)}

    // --- VIDEO UPLOAD AND PLAYER LOGIC ---
    const fabUpload = document.getElementById('fab-upload');
    const uploadModal = document.getElementById('upload-modal');
    const closeUploadModalBtn = document.getElementById('close-upload-modal');
    const uploadForm = document.getElementById('upload-form');
    const submitUploadBtn = document.getElementById('submit-upload-btn');
    const uploadStatus = document.getElementById('upload-status');
    const videoGallery = document.getElementById('video-gallery');
    const playerModal = document.getElementById('video-player-modal');
    const playerVideo = document.getElementById('player-video');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const progressBar = document.getElementById('progress-bar-container');
    const progressFill = document.getElementById('progress-fill');
    const volumeSlider = document.getElementById('volume-slider');
    const likeBtn = document.getElementById('like-btn');
    const commentForm = document.getElementById('comment-form');
    let currentVideoId = null;

    fabUpload.addEventListener('click', () => uploadModal.classList.add('visible'));
    closeUploadModalBtn.addEventListener('click', () => uploadModal.classList.remove('visible'));

    uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const file = document.getElementById('video-file').files[0];
        const title = document.getElementById('video-title').value;
        if (!file || !title) return;
        submitUploadBtn.disabled = true;
        showStatus('جاري تحويل الفيديو...', 'process');
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => saveVideoDataToDB(title, reader.result, file.type);
        reader.onerror = () => { showStatus('فشل تحويل الفيديو!', 'error'); submitUploadBtn.disabled = false; };
    });

    function saveVideoDataToDB(title, base64Video, fileType) {
        showStatus('جاري الرفع إلى قاعدة البيانات...', 'process');
        const videosRef = ref(database, 'videos');
        const newVideoRef = push(videosRef);
        set(newVideoRef, {
            title: title,
            videoBase64: base64Video,
            fileType: fileType,
            likes: 0,
            createdAt: new Date().toISOString()
        }).then(() => {
            showStatus('تم الرفع بنجاح!', 'success');
            setTimeout(() => { uploadModal.classList.remove('visible'); resetUploadForm(); }, 2000);
        }).catch((error) => {
            console.error("Firebase save error:", error);
            showStatus('فشل الرفع! قد يكون حجم الفيديو كبيراً جداً.', 'error');
            resetUploadForm();
        });
    }

    function showStatus(message, type) { uploadStatus.textContent = message; uploadStatus.className = type; uploadStatus.style.display = 'block'; }
    function resetUploadForm() { uploadForm.reset(); submitUploadBtn.disabled = false; setTimeout(() => { uploadStatus.style.display = 'none'; }, 4000); }

    function displayVideoThumbnails() {
        const videosRef = ref(database, 'videos');
        onValue(videosRef, (snapshot) => {
            videoGallery.innerHTML = '';
            const data = snapshot.val();
            if (data) {
                const sortedKeys = Object.keys(data).sort((a,b) => new Date(data[b].createdAt) - new Date(data[a].createdAt));
                sortedKeys.forEach(key => {
                    const card = document.createElement('div');
                    card.className = 'video-card-thumbnail';
                    card.dataset.videoId = key;
                    card.innerHTML = `<img src="https://i.postimg.cc/k4xJ2G23/video-placeholder.jpg" alt="Video thumbnail"><div class="video-card-title">${data[key].title}</div>`;
                    videoGallery.appendChild(card);
                });
            }
        });
    }

    videoGallery.addEventListener('click', (e) => {
        const card = e.target.closest('.video-card-thumbnail');
        if (card) { currentVideoId = card.dataset.videoId; showPlayer(currentVideoId); }
    });

    function showPlayer(videoId) {
        const videoRef = ref(database, `videos/${videoId}`);
        onValue(videoRef, (snapshot) => {
            const data = snapshot.val();
            if (!data || !playerModal.classList.contains('visible')) return;
            likeBtn.querySelector('span').textContent = data.likes || 0;
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';
            if (data.comments) {
                Object.values(data.comments).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp)).forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'comment';
                    commentEl.innerHTML = `<strong class="comment-author">${comment.name || 'مجهول'}</strong><p class="comment-text">${comment.text}</p>`;
                    commentsList.appendChild(commentEl);
                });
            }
        });
        const videoDataRef = ref(database, `videos/${videoId}`);
        onValue(videoDataRef, (snapshot) => {
            const data = snapshot.val();
            if(!data) return;
            playerVideo.src = data.videoBase64;
            document.getElementById('player-download-btn').href = data.videoBase64;
            document.getElementById('player-download-btn').download = `${data.title}.mp4`;
        }, { onlyOnce: true });
        playerModal.classList.add('visible');
    }

    playPauseBtn.addEventListener('click', () => playerVideo.paused ? playerVideo.play() : playerVideo.pause());
    playerVideo.addEventListener('play', () => playPauseBtn.textContent = '❚❚');
    playerVideo.addEventListener('pause', () => playPauseBtn.textContent = '▶');
    playerVideo.addEventListener('timeupdate', () => { progressFill.style.width = `${(playerVideo.currentTime / playerVideo.duration) * 100}%`; });
    progressBar.addEventListener('click', (e) => { playerVideo.currentTime = (e.offsetX / progressBar.offsetWidth) * playerVideo.duration; });
    volumeSlider.addEventListener('input', (e) => playerVideo.volume = e.target.value);
    document.getElementById('close-player-btn').addEventListener('click', () => { playerVideo.pause(); playerVideo.src=""; playerModal.classList.remove('visible'); currentVideoId = null; });
    likeBtn.addEventListener('click', () => { if (!currentVideoId) return; runTransaction(ref(database, `videos/${currentVideoId}/likes`), (likes) => (likes || 0) + 1); });
    commentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!currentVideoId) return;
        const nameInput = document.getElementById('comment-name');
        const textInput = document.getElementById('comment-text');
        const newCommentRef = push(ref(database, `videos/${currentVideoId}/comments`));
        set(newCommentRef, { name: nameInput.value || 'مجهول', text: textInput.value, timestamp: new Date().toISOString() });
        textInput.value = ''; nameInput.value = '';
    });

    function init(){
        buildSlides();
        resetIntervals();
        setTimeout(runNewsTicker, 1000); 
        displayVideoThumbnails();
        animate3D();
        
        els.slideWrap?.addEventListener('click',e=>{if(e.target.matches("button[data-id]")){const p=PROJECTS.find(p=>p.id==e.target.dataset.id);if(p){els.modalTitle.textContent=p.title;els.modalBody.textContent=p.more;els.detailsModal.classList.add('visible')}}});
        els.closeModalBtn?.addEventListener('click',()=>els.detailsModal.classList.remove('visible'));
        els.themeBtn?.addEventListener('click',()=>{const c=els.body.dataset.theme,n=c==='day'?'night':'day';els.body.dataset.theme=n;document.getElementById('theme-icon-sun').style.display=n==='day'?'block':'none';document.getElementById('theme-icon-moon').style.display=n==='day'?'none':'block'});
        els.prevBtn?.addEventListener('click',()=>changeSlide(-1));
        els.nextBtn?.addEventListener('click',()=>changeSlide(1));
        if(els.copyright) els.copyright.textContent=`© ${new Date().getFullYear()} رؤية مصر 2030. جميع الحقوق محفوظة.`
    }
    
    init();
  </script>
</body>
</html>
